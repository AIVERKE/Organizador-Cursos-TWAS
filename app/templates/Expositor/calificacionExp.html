<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calificaciones del Curso</title>  
  <link rel="stylesheet" href="{{ url_for('static', filename='css/Expositor/calificacionExp.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat+Alternates:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="calificacion-container">

    <div class="buscador-container">
      <input type="text" id="buscador" placeholder="Buscar estudiante...">
    </div>

    <div class="tabla-container">
      <table id="tabla-estudiantes">
        <thead>
          <tr>
            <th>Nro</th>
            <th>Apellidos</th>
            <th>Nombres</th>
            <th>Asistencias</th>
            <th>Nota Asistencia</th>
            <th>Nota Acumulada</th>
            <th>Nota Final</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for estudiante in estudiantes %}
            <tr data-id-inscripcion="{{ estudiante.id_inscripcion }}">            
              <td>{{ estudiante.nro }}</td>
              <td>{{ estudiante.apellido }}</td>
              <td>{{ estudiante.nombre }}</td>
              <td>{{ estudiante.total_asistencias }}</td>
              <td>
                <input 
                  type="number"
                  min="0" max="100"
                  value="{{ estudiante.nota_asistencia }}"
                  readonly>
              </td>
              <td>
                <input 
                  type="number"
                  min="0" max="100"
                  value="{{ estudiante.nota_acumulada }}"
                  onchange="confirmarCambioCampo(this, 'nota_acumulada')">
              </td>
              <td>
                <input 
                  type="number" 
                  min="0" max="100" 
                  value="{{ estudiante.nota_final }}" 
                  readonly>
              </td>
              <td class="estado"></td>
            </tr>                    
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <script>
  function actualizarEstado(tr) {
    const notaFinalInput = tr.querySelector("td:nth-child(7) input");
    const notaFinal = parseFloat(notaFinalInput.value);

    const tdAsistencias = tr.querySelector("td:nth-child(4)");
    const asistencias = parseInt(tdAsistencias.textContent);

    const tdEstado = tr.querySelector("td.estado");

    if (asistencias < 1) {
      tdEstado.textContent = "Abandono";
      tdEstado.className = "estado abandono";
    } else if (notaFinal >= 71) {
      tdEstado.textContent = "Aprobado";
      tdEstado.className = "estado aprobado";
    } else if (notaFinal <= 70) {
      tdEstado.textContent = "Certificado de participación";
      tdEstado.className = "estado participacion";
    } else {
      tdEstado.textContent = "Abandono";
      tdEstado.className = "estado abandono";
    }
  }


  function confirmarCambioCampo(input, campo) {
      let nuevoValor = parseFloat(input.value);

      // Limitar nota acumulada a 90
      if (campo === 'nota_acumulada' && nuevoValor > 90) {
          alert("La nota acumulada no puede ser mayor a 90.");
          input.value = input.defaultValue;
          return;
      }

      const tr = input.closest("tr");
      const id_inscripcion = tr.getAttribute("data-id-inscripcion");

      if (confirm(`¿Deseas cambiar ${campo.replace('_', ' ')} a ${nuevoValor}?`)) {
          fetch("/ponente/actualizar_nota", {
              method: "POST",
              headers: {
                  "Content-Type": "application/json"
              },
              body: JSON.stringify({
                  id_inscripcion: id_inscripcion,
                  campo: campo,
                  valor: nuevoValor
              })
          })
          .then(response => {
              if (!response.ok) throw new Error("Error en la actualización");
              return response.json();
          })
          .then(data => {
              if(data.error){
                  alert(data.error);
                  input.value = input.defaultValue;
                  return;
              }

              // Actualizar valor en el input
              input.defaultValue = nuevoValor;
              input.value = nuevoValor;

              // Actualizar nota final si se requiere
              const notaFinalInput = tr.querySelector("td:nth-child(7) input");
              if (campo === 'nota_acumulada') {
                  // Supongamos que la nota final = nota acumulada + nota asistencia
                  const notaAsistencia = parseFloat(tr.querySelector("td:nth-child(5) input").value);
                  const nuevaNotaFinal = Math.min(notaAsistencia + nuevoValor, 100);
                  notaFinalInput.value = nuevaNotaFinal;
              }

              // Actualizar el estado
              actualizarEstado(tr);

              alert("Nota actualizada correctamente.");
          })
          .catch(error => {
              alert("Error al actualizar la nota.");
              input.value = input.defaultValue;
              console.error(error);
          });
      } else {
          input.value = input.defaultValue;
      }
  }


  // Ejecutar al cargar para valores ya existentes
  window.onload = () => {
    document.querySelectorAll("#tabla-estudiantes tbody tr")
      .forEach(tr => actualizarEstado(tr));
  };
  </script>


  <script>
    // Script para filtrar estudiantes
    document.getElementById("buscador").addEventListener("keyup", function() {
      let filtro = this.value.toLowerCase();
      let filas = document.querySelectorAll("#tabla-estudiantes tbody tr");

      filas.forEach(function(fila) {
        let textoFila = fila.textContent.toLowerCase();
        fila.style.display = textoFila.includes(filtro) ? "" : "none";
      });
    });
  </script>

</body>
</html>
